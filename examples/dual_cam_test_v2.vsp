// Dual Camera Diagnostics Test
// This script uses the new role parameter and diagnostic items to debug blank frames

// 1. Discovery
libcam_list()

// 2. Setup with Viewfinder role (often avoids hardware conflicts on Qualcomm)
libcam_setup(0, 1280, 720, "SRGGB10", 4, "Viewfinder")
libcam_setup(1, 1280, 720, "SRGGB10", 4, "Viewfinder")

// 3. Dynamic Bayer Pattern Detection
$bayer0 = libcam_get_bayer(0)
$bayer1 = libcam_get_bayer(1)

print("Camera 0 Bayer: " + $bayer0)
print("Camera 1 Bayer: " + $bayer1)

// 4. Acquisition Loop
loop {
    // Capture from both sequentially to avoid ISP race
    exec_seq {
        video_cap(0, "libcamera") | cache_set("frame0")
        video_cap(1, "libcamera") | cache_set("frame1")
    }
    
    // Process Camera 0
    cache_get("frame0")
    if ($bayer0 != "") {
        cvt_color("bayer" + $bayer0 + "2bgr")
    }
    put_text("CAM 0", 20, 40)
    cache_set("frame0_bgr")
    
    // Process Camera 1
    cache_get("frame1")
    if ($bayer1 != "") {
        cvt_color("bayer" + $bayer1 + "2bgr")
    }
    put_text("CAM 1", 20, 40)
    cache_set("frame1_bgr")
    
    // Stack and show
    cache_get("frame0_bgr") 
    hstack("frame1_bgr")
    
    // Output
    ip_stream()
}
